#!/usr/bin/env bash

# Author: @pwnwriter

check_commands() {
    local required_commands=("zoxide" "fzf" "tmux")

    for cmd in "${required_commands[@]}"; do
        command -v "$cmd" >/dev/null || {
            echo "$cmd not found. Please install it."
            exit 1
        }
    done
}

detach_and_create_new_session() {
    local directory_path="$1"
    local pane_name

    pane_name=$(basename "$directory_path")

    if tmux has-session -t "$pane_name" 2>/dev/null && [ -n "$directory_path" ]; then
        tmux switch-client -t "$pane_name"
    else
        if [ -d "$directory_path" ]; then
            if [ -z "$TMUX" ]; then
                tmux new-session -s "$pane_name" -c "$directory_path"
            else
                tmux switch-client -t "$pane_name" || {
                    echo "Can't find or switch to session: $pane_name"
                    exit 1
                }
            fi
        else
            echo "Directory not found: $directory_path. Please check the path and try again."
            exit 1
        fi
    fi
}

handle_directory() {
    local directory="$1"

    if [ -n "$directory" ]; then
        local directory_path=$(zoxide query "$directory")
        detach_and_create_new_session "$directory_path"
    else
        handle_no_directory
    fi
}

handle_no_directory() {
    local available_sessions=$(tmux list-sessions -F "#{session_name}" 2>/dev/null | sort)

    if [ -z "$available_sessions" ]; then
        echo "No sessions available. Specify a directory to open a new session."
        return
    fi

    local selected_session=$(echo "$available_sessions" | fzf --prompt="ï†—  Available sessions " --height=35% --layout=reverse --border --exit-0)

    if [ -z "$selected_session" ]; then
        echo "No sessions selected."
        return
    fi

    tmux switch-client -t "$selected_session" || {
        echo "Can't find or switch to session: $selected_session"
        exit 1
    }
}

main() {
    check_commands
    handle_directory "$1"
}

# Execute
main "$@"
