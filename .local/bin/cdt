#!/usr/bin/env bash

# Author: @pwnwriter

for cmd in zoxide fzf tmux; do
    command -v "$cmd" >/dev/null || {
        echo "$cmd not found. Please install it."
        exit 1
    }
done

# when no directory is specified
no_directory_specified() {
    available_sessions=$(tmux list-sessions -F "#{session_name}" 2>/dev/null | sort)
    [ -z "$available_sessions" ] && echo "No sessions available, specify a dir to open a new session" && return

    selected_session=$(echo "$available_sessions" | fzf --prompt="ï†—  Available sessions " --height=35% --layout=reverse --border --exit-0)
    [ -z "$selected_session" ] && echo "No sessions selected." && return

    tmux attach-session -t "$selected_session"
}

# when a directory is specified
directory_specified() {
    if tmux has-session -t "$pane_name" 2>/dev/null && [ -n "$directory_path" ]; then
        tmux switch-client -t "$pane_name"
    else
        [ -d "$directory_path" ] && builtin cd "$directory_path" && tmux new-session -s "$pane_name" -c "$directory_path" || {
            echo "Directory not found: $directory. Please check the path and try again."
            exit 1
        }
    fi
}

directory="$1"
directory_path=$(zoxide query "$directory")
pane_name=$(basename "$directory_path")

[ -n "$directory" ] && directory_specified || no_directory_specified
